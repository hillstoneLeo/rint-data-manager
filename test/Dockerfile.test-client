# Custom Dockerfile for test client that extends the base client
FROM python:3.13-slim

# Build arguments for environment variables
ARG DEV_SERVER_IP
ARG DEV_SERVER_PORT

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    sudo \
    openssh-server \
    build-essential \
    libgit2-dev \
    libffi-dev \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy uv binary from build context (assuming it exists in parent context)
COPY ../data/uv /usr/local/bin/uv
RUN chmod +x /usr/local/bin/uv

# Add uv to PATH
ENV PATH="/usr/local/bin:$PATH"

# Install DVC and git using Alibaba Cloud PyPI mirror
RUN uv pip install --system --index-url https://mirrors.aliyun.com/pypi/simple/ dvc[all] && \
    git config --system init.defaultBranch master

# Copy DVC hooks to git templates directory for automatic installation
COPY ../collect-metadata/post-commit /usr/share/git-core/templates/hooks/post-commit
COPY ../collect-metadata/pre-push /usr/share/git-core/templates/hooks/pre-push

# Set env variables used by git hooks
RUN echo "DVC_SERVER_IP=${DEV_SERVER_IP}" > /etc/environment && \
    echo "DVC_SERVER_PORT=${DEV_SERVER_PORT}" >> /etc/environment

# Make scripts executable
RUN chmod +x /usr/share/git-core/templates/hooks/post-commit && \
    chmod +x /usr/share/git-core/templates/hooks/pre-push

# Copy setup scripts from host
COPY test/scripts/setup-users-enhanced /usr/local/bin/setup-users-enhanced
COPY test/scripts/setup-project-git /usr/local/bin/setup-project-git
COPY test/scripts/setup-project-dvc /usr/local/bin/setup-project-dvc
COPY test/scripts/entrypoint.sh /entrypoint.sh

# Copy demo-project template to container (will be used by setup script)
COPY test/demo-project /tmp/demo-project

# Expose SSH port
EXPOSE 22

# Set entrypoint
ENTRYPOINT ["/entrypoint.sh"]
CMD ["bash"]
